<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventory Terminal</title>
<meta name="color-scheme" content="dark">
<style>
:root { --bg: #0b0f0c; --green: #4cff4c; --dim: #2aa12a; --grid: #0f2a0f; }
* { box-sizing: border-box; }
html, body { height: 100%; margin:0; }
body { background: radial-gradient(circle at 50% 50%, #0f160f, var(--bg) 60%);
  color: var(--green); font: 16px/1.4 "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, monospace; }
.crt { padding: 24px; max-width: 1100px; margin: 0 auto; position: relative; overflow: hidden; }
.crt:before, .crt:after { content: ""; position: absolute; pointer-events: none; inset: 0; }
.crt:before { background: repeating-linear-gradient(180deg, rgba(76,255,76,0.05), rgba(76,255,76,0.05) 1px,
 rgba(0,0,0,0) 2px, rgba(0,0,0,0) 3px); mix-blend-mode: overlay; }
.crt:after { box-shadow: inset 0 0 80px rgba(76,255,76,0.1), inset 0 0 180px rgba(76,255,76,0.08); }
header h1 { margin: 0 0 4px 0; letter-spacing: 2px; text-shadow: 0 0 6px rgba(76,255,76,0.6); display:inline-block; }
.subtitle { margin: 0 0 6px 0; color: var(--dim); }
.updated { margin: 0 0 18px 0; color: var(--dim); font-size: 14px; }

.header-cursor { display:inline-block; width:10px; height:1em; background:var(--green); margin-left:6px; vertical-align:baseline; animation: blink 0.8s steps(1) infinite; }
@keyframes blink { 50% { opacity:0; } }

.controls { display: grid; grid-template-columns: 1fr 220px 100px auto; gap: 10px; align-items: center; margin-bottom: 12px; }
input, select, button { background: #061106; border: 1px solid var(--grid); color: var(--green); padding: 8px 10px; outline: none; box-shadow: 0 0 8px rgba(76,255,76,0.12); }
button { cursor: pointer; } button:hover { border-color: var(--dim); }
.stats { text-align: right; color: var(--dim); }
.tableWrap { border: 1px solid var(--grid); background: #050a05; box-shadow: 0 0 16px rgba(76,255,76,0.12); overflow: auto; max-height: 70vh; }
table { width: 100%; border-collapse: collapse; }
thead th { position: sticky; top: 0; background: #071107; color: var(--green); border-bottom: 1px solid var(--grid); text-align: left; padding: 10px; font-weight: 600; }
tbody td { padding: 10px; border-bottom: 1px dashed #0f2a0f; }
.num { text-align: right; white-space: nowrap; }
tbody tr:hover { background: rgba(76,255,76,0.05); }
footer { margin-top: 12px; color: var(--dim); font-size: 14px; }
@media (max-width: 720px) { .controls { grid-template-columns: 1fr 1fr; grid-auto-rows: auto; } .stats { grid-column: 1 / -1; text-align: left; } table { font-size: 14px; } }
.error { color:#ff7070; margin: 8px 0; }

.loader-wrap { position: relative; margin: 16px 0; border:1px solid var(--grid); background:#050a05; padding:16px; overflow:hidden; }
.loader { font-weight:600; letter-spacing:1px; text-shadow:0 0 6px rgba(76,255,76,.6); }
.loader .cursor { display:inline-block; width:10px; background:var(--green); margin-left:4px; animation: blink 1s steps(1) infinite; }
.progress { margin-top:10px; height:10px; border:1px solid var(--grid); position:relative; }
.progress::before { content:""; position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, rgba(76,255,76,.2), rgba(76,255,76,.6)); animation: load 2.2s ease-in-out infinite; }
@keyframes load { 0% { width:10%; } 50% { width:85%; } 100% { width:10%; } }
.scanline { position:absolute; left:0; right:0; height:2px; background:rgba(76,255,76,.25); filter:blur(0.6px); animation: scan 1.6s linear infinite; }
.hidden { display:none; }
</style>
</head>
<body>
  <div class="crt">
    <header>
      <h1>&gt; INVENTORY TERMINAL</h1><span class="header-cursor" aria-hidden="true"></span>
      <p class="subtitle">Cincinnati Computer Reuse // Public Catalog</p>
      <p class="updated" id="lastUpdated">Last updated: —</p>
    </header>

    <div id="loader" class="loader-wrap">
      <div class="loader">LOADING INVENTORY<span class="cursor" aria-hidden="true">&nbsp;</span></div>
      <div class="progress"></div>
      <div class="scanline"></div>
      <div style="color:var(--dim);margin-top:8px;font-size:14px">Fetching data from secure storage… stand by.</div>
    </div>

    <section class="controls hidden" id="controls">
      <input id="search" type="search" placeholder="type to search (name, category)…" autofocus />
      <select id="categoryFilter">
        <option value="">all categories</option>
      </select>
      <button id="resetBtn">reset</button>
      <div class="stats"><span id="count">0</span> items • total qty: <span id="totalQty">0</span></div>
    </section>

    <div id="err" class="error"></div>

    <section class="tableWrap hidden" id="tableWrap">
      <table id="grid">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Category</th>
            <th class="num">Qty</th>
            <th>Date Added</th>
            <th class="num">Est. Price</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>

    <footer>
      <p>Data source: Google Sheets (GViz JSON). Edit the sheet → refresh page.</p>
    </footer>
  </div>

<script>
const GVIZ_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOImwV6nqaSvxQx06Mu5b-gOBkFrvMENj9r3pd_ewznnPHjmRkkI4gGTNPaFxT3D8mZAUTeYcaIMhM/gviz/tq?tqx=out:json&gid=1851981689";
const TZ = "America/New_York";

function fmtTime(d) {
  try { return new Intl.DateTimeFormat('en-US', { dateStyle:'long', timeStyle:'short', timeZone:TZ }).format(d); }
  catch(e) { return d.toLocaleString(); }
}
function setLastUpdated(dateObj) { document.getElementById('lastUpdated').textContent = "Last updated: " + fmtTime(dateObj); }

function showUI() {
  document.getElementById('loader').classList.add('hidden');
  document.getElementById('controls').classList.remove('hidden');
  document.getElementById('tableWrap').classList.remove('hidden');
}
function showError(msg) {
  document.getElementById('loader').classList.add('hidden');
  document.getElementById('err').textContent = msg;
  document.getElementById('controls').classList.remove('hidden');
}

function toNumberSafe(x) { const n = parseFloat(x); return Number.isFinite(n) ? n : 0; }

function uniqueCategories(items) { return Array.from(new Set(items.map(x=>x.cat).filter(Boolean))).sort(); }
function applyFilters(items) {
  const q=document.getElementById('search').value.toLowerCase();
  const cat=document.getElementById('categoryFilter').value;
  return items.filter(it => {
    const matchesQ=(it.name||'').toLowerCase().includes(q)||(it.cat||'').toLowerCase().includes(q);
    const matchesC=!cat||it.cat===cat; return matchesQ&&matchesC;
  });
}

function renderRows(items) {
  const tbody=document.getElementById('rows'); tbody.innerHTML='';
  for (const it of items) {
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.name}</td><td>${it.cat}</td><td class="num">${it.qty}</td><td>${it.date}</td><td class="num">${it.price}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById('count').textContent=items.length;
  document.getElementById('totalQty').textContent=items.reduce((a,b)=>a+(b.qty||0),0);
}

(function initGViz(){
  window.google = window.google || {};
  window.google.visualization = window.google.visualization || {};
  window.google.visualization.Query = window.google.visualization.Query || {
    setResponse: function(resp){
      try {
        if (!resp || !resp.table) throw new Error("Empty response (is the sheet published?)");
        const cols = resp.table.cols.map(c => (c.label || c.id || "").trim());
        const rows = resp.table.rows.map(r => r.c.map(cell => cell ? (cell.f || cell.v || "").toString() : ""));
        const headerMap = {
          name: cols.findIndex(h=>h.toLowerCase()==="item name"),
          cat: cols.findIndex(h=>h.toLowerCase()==="category"),
          qty: cols.findIndex(h=>h.toLowerCase()==="quantity"),
          date: cols.findIndex(h=>h.toLowerCase()==="date added"),
          price: cols.findIndex(h=>h.toLowerCase()==="est. price")
        };
        if (headerMap.name<0||headerMap.cat<0||headerMap.qty<0) throw new Error("Missing required headers. Expect: Item Name, Category, Quantity.");
        const items = rows.map(cells => ({ 
          name: cells[headerMap.name] || "", 
          cat: cells[headerMap.cat] || "", 
          qty: toNumberSafe(cells[headerMap.qty]), 
          date: headerMap.date>-1 ? (cells[headerMap.date]||"") : "", 
          price: headerMap.price>-1 ? (cells[headerMap.price]||"") : "" 
        }));
        const sel=document.getElementById('categoryFilter');
        for (const c of uniqueCategories(items)) { const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt); }
        const refresh=()=>renderRows(applyFilters(items));
        document.getElementById('search').addEventListener('input',refresh);
        document.getElementById('categoryFilter').addEventListener('input',refresh);
        document.getElementById('resetBtn').addEventListener('click',()=>{ document.getElementById('search').value=''; document.getElementById('categoryFilter').value=''; refresh(); });
        renderRows(items);
        setLastUpdated(new Date());
        showUI();
      } catch(e) {
        console.error(e);
        showError("Error parsing sheet: " + e.message);
      }
    }
  };
  const s = document.createElement('script');
  s.src = GVIZ_URL;
  s.onerror = function(){ showError("Network error loading sheet."); };
  document.head.appendChild(s);
})();
</script>
</body>
</html>
